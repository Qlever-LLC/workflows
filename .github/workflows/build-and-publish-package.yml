# Copyright 2022 Qlever LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Build and publish npm package

on:
  workflow_call:
    inputs:
      access:
        description: Publish package as public or private
        type: string
        required: false
        default: public
      oada:
        description: Run an OADA Server instance for tests
        type: boolean
        required: false
        default: false
      oada_version:
        description: Specific version of OADA (git ref)
        type: string
        required: false
        # FIXME: Switch to latest once OADA is updated
        default: edge
    secrets:
      npm_token:
        description: NPM registry token
        required: false

jobs:
  setup:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.ref.outputs.version }}
      release: ${{ steps.ref.outputs.release }}
      major: ${{ steps.ref.outputs.major }}
      minor: ${{ steps.ref.outputs.minor }}
      patch: ${{ steps.ref.outputs.patch }}
      prerelease: ${{ steps.ref.outputs.prerelease }}
      build: ${{ steps.ref.outputs.build }}

    steps:
      - name: Parse Ref
        id: ref
        uses: qlever-llc/workflows/actions/parse-ref@master
      - run: echo "${{ toJSON(steps.ref.outputs) }}"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: borales/actions-yarn@v2.3.0
        with:
          cmd: install # will run `yarn install` command
      - uses: borales/actions-yarn@v2.3.0
        with:
          cmd: build # will run `yarn build` command
      - uses: actions/upload-artifact@v2
        with:
          name: built
          path: |
            .
            !.git

  test-oada:
    if: ${{ inputs.oada }}
    name: Run tests
    runs-on: ubuntu-latest
    needs:
      - build
    services:
      oada:
        image: ghcr.io/qlever-llc/oada:edge
        env:
          OADA_VERSION: ${{ inputs.oada_version || null }}
        volumes:
          # Needed for DooD
          - "/var/run/docker.sock:/var/run/docker.sock"
        ports:
          - "80"
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: built
      - uses: borales/actions-yarn@v2.3.0
        env:
          #DOMAIN: http://localhost:${{ job.services.oada.ports['80'] }}
          DOMAIN: http://oada
          TOKEN: god
        with:
          cmd: test # will run `yarn test` command

  test-no-oada:
    if: ${{ !inputs.oada }}
    name: Run tests
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: built
      - uses: borales/actions-yarn@v2.3.0
        with:
          cmd: test # will run `yarn test` command

  check:
    name: Check build output?
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: built
      - uses: borales/actions-yarn@v2.3.0
        with:
          cmd: |
            tsc \
              --target esnext \
              --moduleResolution node \
              --allowSyntheticDefaultImports

  publish:
    name: Publish package to npm
    needs:
      - setup
      - build
      - test-oada
      - test-no-oada
      - check
    if: ${{ needs.setup.outputs.release }}
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: built
      - uses: borales/actions-yarn@v2.3.0
        env:
          NPM_AUTH_TOKEN: ${{ secrets.npm_token }}
        with:
          cmd: |
            npm publish \
              --access ${{ inputs.access }} \
              --tag ${{ steps.refs.output.prerelease || 'latest' }}

  publish-github:
    name: Publish package to GitHub packages
    needs:
      - setup
      - build
      - test-oada
      - test-no-oada
      - check
    if: ${{ needs.setup.outputs.release }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: built
      - uses: borales/actions-yarn@v2.3.0
        env:
          NPM_AUTH_TOKEN: ${{ github.token }}
          NPM_REGISTRY_URL: https://npm.pkg.github.com
        with:
          cmd: |
            npm publish \
              --access ${{ inputs.access }} \
              --tag ${{ steps.refs.output.prerelease || 'latest' }}
